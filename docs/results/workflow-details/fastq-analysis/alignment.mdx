---
sidebar_position: 4
sidebar_label: Выравнивание
---

# Выравнивание

После успешного выполнения
стадии ["Проверка качества и очистка"](/results/workflow-details/fastq-analysis/check-quality-and-cleanup)
для дальнейшего анализа образца (поиска генетических вариантов, структурных вариаций и вариации числа копий,
а также предсказания фенотипов)
необходимо выполнить выравнивание (картирование) прочтений на референсный геном. Для выравнивания используется
наиболее современная версия генома
человека - [GRCh38.p14](https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000001405.40/).
Если выравнивание [исключено из анализа](/settings/settings/alignment-settings#disable-alignment),
то после успешного выполнения
стадий ["Загрузка, идентификация и проверка"](/results/workflow-details/fastq-analysis/upload-identify-verify)
и ["Проверка качества и очистка"](/results/workflow-details/fastq-analysis/check-quality-and-cleanup) анализ
завершается.
При ошибке выполнения любой из перечисленных ниже задач анализ образца останавливается.

<p align="center">
<img src={require('/img/rus/alignment.png').default} width="650"/>
</p>

Стадия анализа образца "Выравнивание" может включать следующие задачи:
1. **Проверка и восстановление парности прочтений** запускается, если выполняются следующие условия:
   - Анализируется образец парного секвенирования (секвенирование, при котором фрагменты ДНК секвенируют
   с каждого конца навстречу друг другу);
   - Включены [проверка и восстановление парности прочтений](/settings/settings/alignment-settings#disable-repair)
   и/или количество прочтений в парных файлах образца не совпадает.

Проверка и восстановление парности прочтений
производится [BBMap Repair](https://github.com/BioInfoTools/BBMap/blob/master/sh/repair.sh).
В ходе выполнения задачи происходит следующее:
   - Сортировка строк в файлах.
   - Восстановление порядка в парных файлах: первое прочтение в первом файле должно соответствовать
   первому прочтению во втором файле и т.д. Порядок восстанавливается за счёт анализа названий прочтений,
   которые должны быть либо в формате Illumina (идентичный префикс, сопровождаемый "1:" и "2:" или "/1" и "/2"),
   либо полностью идентичны для обоих прочтений в паре.
   - Восстановление парности прочтений, необходимое для выравнивания, чтобы каждое прочтение из одного
файла содержало пару во втором. При очистке прочтений парность может быть нарушена, что приводит
к образованию синглтонов - прочтений, которые лишились пары в парном файле. По умолчанию синглтоны
удаляются из анализа, но их можно оставить в анализе для выравнивания на геном, если включить
[соответствующий параметр](/settings/settings/alignment-settings#use-singleton-reads).

2. **Выравнивание** - определение местоположения прочтений образца на референсном геноме версии hg38.
По умолчанию выравнивание производится с помощью рекомендуемого сообществом
инструмента [BWA2 Burrows-Wheeler Aligner](https://github.com/bwa-mem2/bwa-mem2) (BWA-MEM2) -
новейшей и более быстрой версии алгоритма BWA-MEM, который основан на обратном поиске с преобразованием
Берроуза-Уилера (BWT) и эффективно и быстро выравнивает короткие прочтения секвенирования на геном человека,
допуская мисмэтчи и гэпы[^1]. Этот выравниватель
можно [поменять в параметрах](/settings/settings/alignment-settings#change-alignment-tool)
на *BWA Burrows-Wheeler Aligner* - более раннюю версию алгоритма BWA-MEM[^2], *Bowtie2*[^3], *HISAT2*[^4]
или *STAR*[^5]. Выравнивание записывается в файл в формате SAM (текстовый файл для хранения биологических
последовательностей, выровненных на референсную последовательность).

После выравнивания картированные прочтения сортируются по крайним левым координатам с
помощью [samtools sort](http://www.htslib.org/doc/samtools-sort.html) и записываются в файл в
формате BAM (бинарный эквивалент формата SAM; занимает меньше места и позволяет быстрее работать с информацией,
чем SAM). Получившийся файл можно скачать в разделе "*Файлы с результатами*" в деталях задачи "*Выравнивание*"
("*Скачать BAM*"). Также этот файл можно открыть в IGV, нажав на ссылку "*Открыть в IGV браузере*".
Полученный BAM файл индексируется с
помощью [samtools index](http://www.htslib.org/doc/samtools-index.html).
Получившийся индексный файл можно скачать в том же разделе ("*Скачать BAI*").

:::info На заметку
Если вы хотите добавить в вашу [десктопную версию IGV](https://igv.org/doc/desktop/) трек выравнивания,
полученного в результате анализа загруженного вами образца в Genomenal, вы можете сделать это через ссылку. Для этого
сделайте следующее:
1. Нажмите правой кнопкой мыши на ссылку на файл выравнивания "*Скачать BAM*"
и выберите опцию "*Копировать адрес ссылки*".
2. Загрузите трек через URL в вашу десктопную версию IGV, как это
описано [здесь](https://igv.org/doc/desktop/#UserGuide/loading_data/).
3. Нажмите правой кнопкой мыши на ссылку на индексный файл выравнивания "*Скачать BAI*"
и выберите опцию "*Копировать адрес ссылки*".
4. Добавьте URL индексного файла в соответствующее поле в IGV.
5. Нажмите "*OK*". Готово! Трек выравнивания образца добавлен в IGV.
:::

В разделе "*Метрики*" в деталях задачи "*Выравнивание*" приведены метрики оценки качества выравнивания:

<p align="center">
<img src={require('/img/rus/alignment_metrics.png').default} width="900"/>
</p>

Для каждой метрики приведены:
- название метрики;
- описание результата проверки соответствия определенного показателя выравнивания образца и порога этой метрики:
приведены значение показателя для образца (например, доля картированных прочтений в файле выравнивания - Mapped
reads) и использованный порог метрики, при котором файл выравнивания считается качественным (можно поменять
в [параметрах](/settings/settings/alignment-settings#change-metric-thresholds));
- результат оценки качества выравнивания
по метрике: <img src={require('/img/rus/passed_metric.png').default} width="90"/>, если выравнивание образца
удовлетворяет порогу метрики, <br></br>или <img src={require('/img/rus/failed_metric.png').default} width="80"/>,
если не удовлетворяет.

#### Метрики оценки качества выравнивания {#alignment-metrics}

<table>
  <tr>
   <td>Метрика</td>
   <td>Значение порога метрики, при котором файл выравнивания считается качественным (значение по умолчанию, может
   быть изменено в <a href="/settings/settings/alignment-settings#change-metric-thresholds">параметрах</a>)</td>
  </tr>
  <tr>
   <td><b>Mapped reads</b> (картированные прочтения)</td>
   <td>В файле выравнивания не менее 85% картированных прочтений.</td>
  </tr>
  <tr>
   <td><b>Multiple alignments</b> (множественные выравнивания)</td>
   <td>В файле выравнивания не более 15% множественных выравниваний одного и тоже прочтения на геном.</td>
  </tr>
  <tr>
   <td><b>Forward/reverse balance</b> (равновесие прочтений с прямой и обратной цепи)</td>
   <td>Разница в количестве прочтений с прямой цепи и прочтений с обратной цепи не более 10% в файле выравнивания.</td>
  </tr>
  <tr>
   <td><b>Paired mapped reads</b> (картированные парные прочтения)</td>
   <td>В файле выравнивания не менее 80% картированных парных прочтений.</td>
  </tr>
  <tr>
   <td><b>Paired properly mapped reads</b> (правильно картированные парные прочтения)</td>
   <td>В файле выравнивания не менее 75% правильно картированных парных прочтений.</td>
  </tr>
  <tr>
   <td><b>Coverage per nucleotide</b> (понуклеотидное покрытие)</td>
   <td>Минимально допустимое понуклеотидное покрытие на геноме - 0.1.</td>
  </tr>
</table>

Если значение метрики в файле выравнивания образца не удовлетворяет установленному порогу,
то файл отмечается как не удовлетворяющий требованиям метрики, т.е. выравнивание завершается успешно,
а в статусе стадии указывается количество метрик, которые не соответствуют критериям.
Если же никакие прочтения образца не выровнялись на геном, то стадия "Выравнивание" завершается с ошибкой
и анализ останавливается.

Если в анализ образца включена хотя бы одна из стадий: выявление
[соматических SNVs/Indels](/settings/settings/variant-discovery-settings#somatic-snvs-discovery),
[герминальных SNVs/Indels](/settings/settings/variant-discovery-settings#germline-snvs-discovery),
[структурных вариаций](/settings/settings/variant-discovery-settings#sv-discovery),
[вариации числа копий](/settings/settings/variant-discovery-settings#cnv-discovery),
[предсказание фенотипов](/settings/settings/variant-discovery-settings#enable-phenotype-prediction)
или [вычисление полигенных рисков](/settings/settings/variant-discovery-settings#polygenic-risk-scores-calculation),
то после успешного выполнения задачи "Выравнивание" начнётся выполнение
[стадии "Предварительная обработка для выявления вариантов"](/results/workflow-details/fastq-analysis/variant-discovery-preprocessing).

3. **Определение набора capture kit**

Если пользователь определил тип секвенирования образца как WGS (whole-genome sequencing;
полногеномное секвенирование), то определение набора capture kit не проводится, а тип секвенирования
может остаться WGS или переопределиться в Low-pass WGS (полногеномное секвенирование с низким покрытием).
WGS и Low-pass WGS разделяются по среднему покрытию образца: тип секвенирования образцов со средним
покрытием меньше 4x определяется как Low-pass WGS, а выше или равно 4x - как WGS.

Если пользователь определил тип секвенирования как Направленный отбор, то тип секвенирования может
определиться как Панель (секвенирование с помощью таргетной панели) или WES (whole-exome sequencing;
полноэкзомное секвенирование). Далее определяется наиболее подходящий для образца набор
capture kit (таргетная панель, используемая при направленном отборе) или вычисляются статистики
покрытия образца набором capture kit, выбранным пользователем:
- [bedtools genomecov](https://bedtools.readthedocs.io/en/latest/content/tools/genomecov.html)
вычисляет покрытие выровненных последовательностей образца на референсный геном и выдает выходные
данные о полногеномном покрытии в формате [bedGraph](http://genome.ucsc.edu/goldenPath/help/bedgraph.html) (Файл A).
- [bedtools intersect](https://bedtools.readthedocs.io/en/latest/content/tools/intersect.html)
выявляет совпадения между Файлом A и либо набором capture kit, выбранным для образца пользователем,
либо каждым набором capture kit, который [встроен или загружен](/settings/capture-kits)
в систему, если пользователь не выбрал capture kit. Для этих capture kit рассчитываются индекс покрытия,
глубина, суммарная длина интервалов и длина
пересечения покрытия выровненных последовательностей образца с интервалами capture kit, а также процент покрытия.
- Для capture kit, выбранного пользователем, или для наиболее подходящего набора capture kit
среди рассмотренных на предыдущем этапе
наборов [bedtools complement](https://bedtools.readthedocs.io/en/latest/content/tools/complement.html)
строит файл со всеми интервалами в геноме, которые не покрыты хотя бы одним интервалом в файле capture
kit (Файл B).
- [bedtools intersect](https://bedtools.readthedocs.io/en/latest/content/tools/intersect.html)
находит совпадения между Файлом A и Файлом B, вычисляя индекс покрытия, глубину и длину пересечения этих файлов.

В результате, если пользователь не выбрал capture kit и если в ходе выполнения задачи удалось
найти наиболее подходящий для образца набор capture kit, то анализ образца идёт дальше с этим набором.
Если подходящий capture kit не удалось найти, то для образца не будут выполнены фильтрация SNVs/Indels
(поиск вариантов в тех же геномных интервалах, в которых проводилось таргетного секвенирование)
и выявление вариации числа копий.
Файл со статистиками набора capture kit, выбранного пользователем или определенного системой, можно скачать
в разделе "*Файлы с результатами*" в деталях задачи "*Определение набора capture kit*"
("*Скачать Capture kit stats JSON*").

[^1]: [Vasimuddin M., Sanchit M., Heng L., Srinivas A. Efficient Architecture-Aware Acceleration of BWA-MEM for Multicore Systems. IEEE Parallel and Distributed Processing Symposium (IPDPS) (2019)](https://doi.org/10.1109/IPDPS.2019.00041)
[^2]: [Li H. Aligning sequence reads, clone sequences and assembly contigs with BWA-MEM. arXiv:1303.3997v2 (2013)](https://doi.org/10.48550/arXiv.1303.3997)
[^3]: [Langmead B., Salzberg S. Fast gapped-read alignment with Bowtie 2. Nature Methods 9, 357:359 (2012)](https://doi.org/10.1038/nmeth.1923)
[^4]: [Kim D., Paggi J.M., Park C. et al. Graph-based genome alignment and genotyping with HISAT2 and HISAT-genotype. Nat Biotechnol 37, 907:915 (2019)](https://doi.org/10.1038/s41587-019-0201-4)
[^5]: [Dobin A., Davis C.A., Schlesinger F. et al. STAR: ultrafast universal RNA-seq aligner. Bioinformatics 29(1), 15:21 (2013)](https://doi.org/10.1093/bioinformatics/bts635)
